<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>RAG Chatbot</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    :root {
      --bg-primary: #0f0f14;
      --bg-secondary: #1a1a22;
      --bg-chat: #15151c;
      --bg-user: #6366f1;
      --bg-assistant: #252530;
      --border: #2d2d3a;
      --text-primary: #f0f0f5;
      --text-secondary: #9898a8;
      --text-muted: #6b6b7a;
      --accent: #6366f1;
      --accent-hover: #7c7ff2;
      --success: #22c55e;
      --error: #f43f5e;
      --warning: #f59e0b;
    }

    body {
      font-family: 'Inter', -apple-system, sans-serif;
      background: var(--bg-primary);
      color: var(--text-primary);
      height: 100vh;
      overflow: hidden;
    }

    .app {
      display: flex;
      height: 100vh;
      max-width: 1400px;
      margin: 0 auto;
    }

    /* Sidebar - Training Panel */
    .sidebar {
      width: 320px;
      background: var(--bg-secondary);
      border-right: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      padding: 20px;
      gap: 20px;
    }

    .sidebar-header {
      display: flex;
      align-items: center;
      gap: 12px;
      padding-bottom: 16px;
      border-bottom: 1px solid var(--border);
    }

    .logo {
      width: 40px;
      height: 40px;
      background: linear-gradient(135deg, var(--accent), #8b5cf6);
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
    }

    .sidebar-title { font-size: 18px; font-weight: 600; }
    .session-badge {
      font-size: 11px;
      color: var(--text-muted);
      background: var(--bg-primary);
      padding: 4px 8px;
      border-radius: 6px;
      font-family: monospace;
      margin-top: 4px;
    }

    .section { margin-bottom: 8px; }
    .section-title {
      font-size: 12px;
      font-weight: 600;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 12px;
    }

    .input-group { display: flex; flex-direction: column; gap: 10px; }

    input[type="text"], input[type="url"] {
      background: var(--bg-primary);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 12px 14px;
      color: var(--text-primary);
      font-size: 14px;
      outline: none;
      transition: border-color 0.2s;
    }
    input:focus { border-color: var(--accent); }
    input::placeholder { color: var(--text-muted); }

    .btn {
      background: var(--accent);
      color: white;
      border: none;
      border-radius: 8px;
      padding: 12px 16px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }
    .btn:hover { background: var(--accent-hover); }
    .btn:disabled { opacity: 0.6; cursor: not-allowed; }
    .btn-secondary {
      background: var(--bg-primary);
      border: 1px solid var(--border);
    }
    .btn-secondary:hover { background: var(--border); }
    .btn-warning {
      background: var(--warning);
      color: #000;
    }
    .btn-warning:hover { background: #d97706; }
    .btn-danger {
      background: var(--error);
    }
    .btn-danger:hover { background: #dc2626; }
    .btn-sm {
      padding: 8px 12px;
      font-size: 12px;
    }
    .btn-group {
      display: flex;
      gap: 8px;
    }

    .file-input-wrapper {
      position: relative;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .file-input {
      position: absolute;
      width: 100%;
      height: 100%;
      opacity: 0;
      cursor: pointer;
    }
    .file-label {
      background: var(--bg-primary);
      border: 2px dashed var(--border);
      border-radius: 8px;
      padding: 20px;
      text-align: center;
      color: var(--text-secondary);
      font-size: 13px;
      cursor: pointer;
      transition: all 0.2s;
    }
    .file-label:hover { border-color: var(--accent); color: var(--text-primary); }
    .file-label.has-file { border-color: var(--success); color: var(--success); }

    .status-message {
      padding: 10px 12px;
      border-radius: 8px;
      font-size: 13px;
      display: none;
      animation: fadeIn 0.2s ease;
    }
    .status-message.show { display: block; }
    .status-message.success { background: rgba(34, 197, 94, 0.15); color: var(--success); }
    .status-message.error { background: rgba(244, 63, 94, 0.15); color: var(--error); }
    .status-message.loading { background: rgba(99, 102, 241, 0.15); color: var(--accent); }

    /* Main Chat Area */
    .chat-main {
      flex: 1;
      display: flex;
      flex-direction: column;
      background: var(--bg-chat);
    }

    .chat-header {
      padding: 16px 24px;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .chat-header h2 { font-size: 16px; font-weight: 600; }
    .chat-header .hint { font-size: 13px; color: var(--text-muted); }

    .messages {
      flex: 1;
      overflow-y: auto;
      padding: 24px;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .message {
      max-width: 75%;
      padding: 14px 18px;
      border-radius: 16px;
      font-size: 14px;
      line-height: 1.6;
      animation: slideIn 0.2s ease;
    }
    .message.user {
      align-self: flex-end;
      background: var(--bg-user);
      border-bottom-right-radius: 4px;
    }
    .message.assistant {
      align-self: flex-start;
      background: var(--bg-assistant);
      border-bottom-left-radius: 4px;
    }
    .message.system {
      align-self: center;
      background: transparent;
      color: var(--text-muted);
      font-size: 13px;
      padding: 8px 16px;
    }

    .typing-indicator {
      display: flex;
      gap: 4px;
      padding: 14px 18px;
      background: var(--bg-assistant);
      border-radius: 16px;
      border-bottom-left-radius: 4px;
      width: fit-content;
    }
    .typing-dot {
      width: 8px;
      height: 8px;
      background: var(--text-muted);
      border-radius: 50%;
      animation: bounce 1.4s infinite ease-in-out;
    }
    .typing-dot:nth-child(2) { animation-delay: 0.2s; }
    .typing-dot:nth-child(3) { animation-delay: 0.4s; }

    .chat-input-area {
      padding: 16px 24px 24px;
      border-top: 1px solid var(--border);
    }
    .chat-input-wrapper {
      display: flex;
      gap: 12px;
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 8px;
    }
    .chat-input {
      flex: 1;
      background: transparent;
      border: none;
      padding: 10px 12px;
      color: var(--text-primary);
      font-size: 14px;
      outline: none;
      resize: none;
      font-family: inherit;
    }
    .chat-input::placeholder { color: var(--text-muted); }
    .send-btn {
      background: var(--accent);
      border: none;
      border-radius: 8px;
      width: 44px;
      height: 44px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }
    .send-btn:hover { background: var(--accent-hover); }
    .send-btn:disabled { opacity: 0.5; cursor: not-allowed; }
    .send-btn svg { width: 20px; height: 20px; fill: white; }

    .empty-state {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      color: var(--text-muted);
      text-align: center;
      padding: 40px;
    }
    .empty-state-icon { font-size: 48px; margin-bottom: 16px; }
    .empty-state h3 { color: var(--text-secondary); margin-bottom: 8px; }

    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes bounce {
      0%, 80%, 100% { transform: translateY(0); }
      40% { transform: translateY(-6px); }
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    .spinner {
      width: 16px;
      height: 16px;
      border: 2px solid rgba(255,255,255,0.3);
      border-top-color: white;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    /* Responsive */
    @media (max-width: 768px) {
      .app { flex-direction: column; }
      .sidebar { width: 100%; max-height: 40vh; overflow-y: auto; }
      .message { max-width: 90%; }
    }
  </style>
</head>
<body>
  <div class="app">
    <!-- Sidebar - Training Panel -->
    <aside class="sidebar">
      <div class="sidebar-header">
        <div class="logo">ü§ñ</div>
        <div>
          <div class="sidebar-title">RAG Chatbot</div>
          <div class="session-badge" id="sessionBadge">Session: ---</div>
        </div>
      </div>

      <!-- Train from URL -->
      <div class="section">
        <div class="section-title">Train from Website</div>
        <div class="input-group">
          <input type="url" id="urlInput" placeholder="https://example.com/docs" />
          <button class="btn" id="crawlBtn" onclick="trainFromUrl()">
            <span>üåê</span> Train Website
          </button>
          <div class="status-message" id="urlStatus"></div>
        </div>
      </div>

      <!-- Train from File -->
      <div class="section">
        <div class="section-title">Train from Document</div>
        <div class="input-group">
          <div class="file-input-wrapper">
            <label class="file-label" id="fileLabel">
              üìÑ Drop file or click to upload<br>
              <small>PDF, TXT, DOCX</small>
            </label>
            <input type="file" class="file-input" id="fileInput" accept=".pdf,.txt,.docx" onchange="handleFileSelect(this)" />
          </div>
          <button class="btn btn-secondary" id="uploadBtn" onclick="trainFromFile()" disabled>
            <span>üì§</span> Train Document
          </button>
          <div class="status-message" id="fileStatus"></div>
        </div>
      </div>

      <!-- Session Controls -->
      <div class="section" style="margin-top: auto; padding-top: 20px; border-top: 1px solid var(--border);">
        <div class="section-title">Session Controls</div>
        <div class="btn-group">
          <button class="btn btn-warning btn-sm" onclick="resetConversation()" title="Clear chat history, keep knowledge">
            üîÅ Reset Chat
          </button>
          <button class="btn btn-danger btn-sm" onclick="resetKnowledge()" title="Delete all trained knowledge">
            üóëÔ∏è Reset All
          </button>
        </div>
        <div class="status-message" id="resetStatus"></div>
      </div>
    </aside>

    <!-- Main Chat Area -->
    <main class="chat-main">
      <div class="chat-header">
        <h2>üí¨ Chat</h2>
        <span class="hint">Ask questions about your trained content</span>
      </div>

      <div class="messages" id="messages">
        <div class="empty-state" id="emptyState">
          <div class="empty-state-icon">üí°</div>
          <h3>Start a conversation</h3>
          <p>Train the chatbot with a website or document,<br>then ask questions about the content.</p>
        </div>
      </div>

      <div class="chat-input-area">
        <div class="chat-input-wrapper">
          <input type="text" class="chat-input" id="chatInput" placeholder="Ask a question..." onkeydown="handleChatKeydown(event)" />
          <button class="send-btn" id="sendBtn" onclick="sendMessage()">
            <svg viewBox="0 0 24 24"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg>
          </button>
        </div>
      </div>
    </main>
  </div>

  <script>
    // Session ID - generated once per page load
    const SESSION_ID = 'session_' + Math.random().toString(36).substring(2, 10);
    
    // Chat history in memory
    let chatHistory = [];
    let selectedFile = null;
    let isTrainingComplete = false;

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
      document.getElementById('sessionBadge').textContent = `Session: ${SESSION_ID.slice(-8)}`;
    });

    // === Training Functions ===
    
    async function trainFromUrl() {
      const urlInput = document.getElementById('urlInput');
      const btn = document.getElementById('crawlBtn');
      const status = document.getElementById('urlStatus');
      const url = urlInput.value.trim();
      
      if (!url) {
        showStatus(status, 'Please enter a URL', 'error');
        return;
      }

      btn.disabled = true;
      btn.innerHTML = '<span class="spinner"></span> Crawling...';
      showStatus(status, 'Crawling website... This may take a minute.', 'loading');

      try {
        const res = await fetch('/crawl', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ baseUrl: url, session_id: SESSION_ID })
        });
        const data = await res.json();

        if (res.ok) {
          showStatus(status, `‚úì Trained on ${data.pages_crawled} pages (${data.chunks_created} chunks)`, 'success');
          isTrainingComplete = true;
          addSystemMessage('Website trained successfully! You can now ask questions.');
        } else {
          showStatus(status, `Error: ${data.detail || 'Failed to crawl'}`, 'error');
        }
      } catch (e) {
        showStatus(status, 'Error: Could not connect to server', 'error');
      }

      btn.disabled = false;
      btn.innerHTML = '<span>üåê</span> Train Website';
    }

    function handleFileSelect(input) {
      const fileLabel = document.getElementById('fileLabel');
      const uploadBtn = document.getElementById('uploadBtn');
      
      if (input.files && input.files[0]) {
        selectedFile = input.files[0];
        fileLabel.textContent = `üìÑ ${selectedFile.name}`;
        fileLabel.classList.add('has-file');
        uploadBtn.disabled = false;
      } else {
        selectedFile = null;
        fileLabel.innerHTML = 'üìÑ Drop file or click to upload<br><small>PDF, TXT, DOCX</small>';
        fileLabel.classList.remove('has-file');
        uploadBtn.disabled = true;
      }
    }

    async function trainFromFile() {
      if (!selectedFile) return;

      const btn = document.getElementById('uploadBtn');
      const status = document.getElementById('fileStatus');

      btn.disabled = true;
      btn.innerHTML = '<span class="spinner"></span> Processing...';
      showStatus(status, 'Processing document...', 'loading');

      const formData = new FormData();
      formData.append('file', selectedFile);
      formData.append('session_id', SESSION_ID);

      try {
        const res = await fetch('/ingest/file', {
          method: 'POST',
          body: formData
        });
        const data = await res.json();

        if (res.ok) {
          showStatus(status, `‚úì Trained on ${selectedFile.name} (${data.chunks_created} chunks)`, 'success');
          isTrainingComplete = true;
          addSystemMessage('Document trained successfully! You can now ask questions.');
        } else {
          showStatus(status, `Error: ${data.detail || 'Failed to process file'}`, 'error');
        }
      } catch (e) {
        showStatus(status, 'Error: Could not connect to server', 'error');
      }

      btn.disabled = false;
      btn.innerHTML = '<span>üì§</span> Train Document';
    }

    // === Chat Functions ===

    function handleChatKeydown(e) {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    }

    async function sendMessage() {
      const input = document.getElementById('chatInput');
      const sendBtn = document.getElementById('sendBtn');
      const question = input.value.trim();
      
      if (!question) return;

      // Hide empty state
      document.getElementById('emptyState').style.display = 'none';

      // Add user message
      addMessage(question, 'user');
      chatHistory.push({ role: 'user', content: question });
      input.value = '';

      // Show typing indicator
      sendBtn.disabled = true;
      const typingId = showTypingIndicator();

      try {
        const res = await fetch('/ask', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ question, session_id: SESSION_ID })
        });
        const data = await res.json();

        removeTypingIndicator(typingId);

        if (res.ok) {
          addMessage(data.answer, 'assistant');
          chatHistory.push({ role: 'assistant', content: data.answer });
        } else {
          addMessage(`Error: ${data.detail || 'Failed to get answer'}`, 'assistant');
        }
      } catch (e) {
        removeTypingIndicator(typingId);
        addMessage('Error: Could not connect to server', 'assistant');
      }

      sendBtn.disabled = false;
      input.focus();
    }

    // === UI Helpers ===

    function addMessage(text, role) {
      const container = document.getElementById('messages');
      const msg = document.createElement('div');
      msg.className = `message ${role}`;
      msg.textContent = text;
      container.appendChild(msg);
      container.scrollTop = container.scrollHeight;
    }

    function addSystemMessage(text) {
      const container = document.getElementById('messages');
      document.getElementById('emptyState').style.display = 'none';
      const msg = document.createElement('div');
      msg.className = 'message system';
      msg.textContent = text;
      container.appendChild(msg);
      container.scrollTop = container.scrollHeight;
    }

    function showTypingIndicator() {
      const container = document.getElementById('messages');
      const id = 'typing-' + Date.now();
      const indicator = document.createElement('div');
      indicator.id = id;
      indicator.className = 'typing-indicator';
      indicator.innerHTML = '<div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div>';
      container.appendChild(indicator);
      container.scrollTop = container.scrollHeight;
      return id;
    }

    function removeTypingIndicator(id) {
      const indicator = document.getElementById(id);
      if (indicator) indicator.remove();
    }

    function showStatus(element, message, type) {
      element.textContent = message;
      element.className = `status-message show ${type}`;
    }

    // === Reset Functions ===

    async function resetConversation() {
      if (!confirm('Clear conversation history? Your trained knowledge will be preserved.')) {
        return;
      }

      const status = document.getElementById('resetStatus');
      showStatus(status, 'Clearing conversation...', 'loading');

      try {
        const res = await fetch('/reset/conversation', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ session_id: SESSION_ID })
        });
        const data = await res.json();

        if (res.ok) {
          // Clear local chat UI
          chatHistory = [];
          const messagesContainer = document.getElementById('messages');
          messagesContainer.innerHTML = `
            <div class="empty-state" id="emptyState">
              <div class="empty-state-icon">üí°</div>
              <h3>Conversation cleared</h3>
              <p>Your trained knowledge is preserved.<br>Start asking new questions!</p>
            </div>
          `;
          showStatus(status, '‚úì Conversation cleared', 'success');
          setTimeout(() => { status.className = 'status-message'; }, 3000);
        } else {
          showStatus(status, `Error: ${data.detail || 'Failed to reset'}`, 'error');
        }
      } catch (e) {
        showStatus(status, 'Error: Could not connect to server', 'error');
      }
    }

    async function resetKnowledge() {
      if (!confirm('‚ö†Ô∏è Delete ALL trained knowledge and conversation?\n\nThis cannot be undone. You will need to train the chatbot again.')) {
        return;
      }

      const status = document.getElementById('resetStatus');
      showStatus(status, 'Deleting knowledge...', 'loading');

      try {
        const res = await fetch('/reset/knowledge', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ session_id: SESSION_ID })
        });
        const data = await res.json();

        if (res.ok) {
          // Reset all UI state
          chatHistory = [];
          isTrainingComplete = false;
          selectedFile = null;
          
          // Reset file input
          document.getElementById('fileInput').value = '';
          document.getElementById('fileLabel').innerHTML = 'üìÑ Drop file or click to upload<br><small>PDF, TXT, DOCX</small>';
          document.getElementById('fileLabel').classList.remove('has-file');
          document.getElementById('uploadBtn').disabled = true;
          
          // Reset URL input
          document.getElementById('urlInput').value = '';
          
          // Clear status messages
          document.getElementById('urlStatus').className = 'status-message';
          document.getElementById('fileStatus').className = 'status-message';
          
          // Reset chat
          document.getElementById('messages').innerHTML = `
            <div class="empty-state" id="emptyState">
              <div class="empty-state-icon">üí°</div>
              <h3>Start a conversation</h3>
              <p>Train the chatbot with a website or document,<br>then ask questions about the content.</p>
            </div>
          `;
          
          showStatus(status, '‚úì All knowledge deleted', 'success');
          setTimeout(() => { status.className = 'status-message'; }, 3000);
        } else {
          showStatus(status, `Error: ${data.detail || 'Failed to reset'}`, 'error');
        }
      } catch (e) {
        showStatus(status, 'Error: Could not connect to server', 'error');
      }
    }
  </script>
</body>
</html>
